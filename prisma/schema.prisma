generator client {
  provider = "prisma-client"
  output   = "../server/prisma-client"
  runtime  = "workerd"
}

datasource db {
  provider = "sqlite"
}

/// ユーザーテーブル
/// Google/GitHub OAuth認証に対応したユーザー情報を管理する
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  
  /// ユーザーのプロフィール画像URL（OAuth プロバイダーから取得）
  avatarUrl String?
  
  /// 自己紹介文（プロフィール編集で設定可能）
  bio       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  /// ユーザーに紐づく認証アカウント（複数のプロバイダーでログイン可能）
  accounts  Account[]

  /// 所属する組織
  memberships OrganizationMember[]
}

/// 認証アカウントテーブル
/// OAuth プロバイダー（Google/GitHub）との紐付けを管理する
/// 1ユーザーが複数のプロバイダーでログインできるよう設計
model Account {
  id         Int      @id @default(autoincrement())
  
  /// 認証プロバイダー種別（"google" または "github"）
  provider   String
  
  /// プロバイダー側のユーザー識別子
  providerId String
  
  /// ユーザーへの外部キー
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  /// 同一プロバイダー・同一プロバイダーIDの組み合わせは一意
  @@unique([provider, providerId])
}

/// 組織での役割
enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

/// 組織テーブル
model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     OrganizationMember[]
  invitations OrganizationInvitation[]
}

/// 組織メンバーテーブル
model OrganizationMember {
  id             Int              @id @default(autoincrement())
  organizationId Int
  userId         Int
  role           OrganizationRole
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

/// 組織招待テーブル
model OrganizationInvitation {
  id             Int              @id @default(autoincrement())
  organizationId Int
  email          String
  role           OrganizationRole
  token          String           @unique
  expiresAt      DateTime
  createdAt      DateTime         @default(now())
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
}

